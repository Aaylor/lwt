<html>
  <head>
    <title>Coverage report</title>
    <link rel="stylesheet" href="style.css" />
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="index.html">
          <span class="dirname">src/unix/</span>lwt_engine.ml
        </a>
      </h1>
      <h2>54.02%</h2>
    </div>
    <div id="navbar">
      <span class="unvisited" style="top:16.18%"></span>
      <span class="unvisited" style="top:16.40%"></span>
      <span class="unvisited" style="top:16.63%"></span>
      <span class="unvisited" style="top:17.08%"></span>
      <span class="unvisited" style="top:17.75%"></span>
      <span class="unvisited" style="top:17.98%"></span>
      <span class="unvisited" style="top:18.20%"></span>
      <span class="unvisited" style="top:18.43%"></span>
      <span class="unvisited" style="top:18.65%"></span>
      <span class="unvisited" style="top:18.88%"></span>
      <span class="unvisited" style="top:19.55%"></span>
      <span class="unvisited" style="top:19.78%"></span>
      <span class="unvisited" style="top:20.00%"></span>
      <span class="unvisited" style="top:20.22%"></span>
      <span class="unvisited" style="top:25.39%"></span>
      <span class="unvisited" style="top:25.62%"></span>
      <span class="unvisited" style="top:25.84%"></span>
      <span class="unvisited" style="top:35.06%"></span>
      <span class="unvisited" style="top:35.28%"></span>
      <span class="unvisited" style="top:35.51%"></span>
      <span class="unvisited" style="top:35.73%"></span>
      <span class="unvisited" style="top:35.96%"></span>
      <span class="unvisited" style="top:36.18%"></span>
      <span class="unvisited" style="top:36.40%"></span>
      <span class="unvisited" style="top:36.85%"></span>
      <span class="unvisited" style="top:40.45%"></span>
      <span class="unvisited" style="top:40.67%"></span>
      <span class="unvisited" style="top:41.12%"></span>
      <span class="unvisited" style="top:41.80%"></span>
      <span class="unvisited" style="top:42.25%"></span>
      <span class="unvisited" style="top:42.70%"></span>
      <span class="unvisited" style="top:43.37%"></span>
      <span class="unvisited" style="top:43.60%"></span>
      <span class="unvisited" style="top:44.27%"></span>
      <span class="unvisited" style="top:44.49%"></span>
      <span class="unvisited" style="top:45.17%"></span>
      <span class="unvisited" style="top:45.39%"></span>
      <span class="unvisited" style="top:46.07%"></span>
      <span class="unvisited" style="top:57.75%"></span>
      <span class="unvisited" style="top:57.98%"></span>
      <span class="unvisited" style="top:58.20%"></span>
      <span class="unvisited" style="top:58.43%"></span>
      <span class="some-visited" style="top:59.33%"></span>
      <span class="unvisited" style="top:59.78%"></span>
      <span class="unvisited" style="top:64.72%"></span>
      <span class="some-visited" style="top:65.39%"></span>
      <span class="unvisited" style="top:65.62%"></span>
      <span class="unvisited" style="top:66.07%"></span>
      <span class="unvisited" style="top:66.29%"></span>
      <span class="unvisited" style="top:66.52%"></span>
      <span class="unvisited" style="top:66.97%"></span>
      <span class="unvisited" style="top:67.19%"></span>
      <span class="unvisited" style="top:79.78%"></span>
      <span class="unvisited" style="top:84.49%"></span>
      <span class="unvisited" style="top:84.72%"></span>
      <span class="unvisited" style="top:85.17%"></span>
      <span class="unvisited" style="top:85.39%"></span>
      <span class="unvisited" style="top:85.62%"></span>
      <span class="unvisited" style="top:86.07%"></span>
      <span class="unvisited" style="top:86.52%"></span>
      <span class="unvisited" style="top:86.74%"></span>
      <span class="unvisited" style="top:87.42%"></span>
      <span class="unvisited" style="top:87.87%"></span>
      <span class="unvisited" style="top:88.54%"></span>
      <span class="unvisited" style="top:89.21%"></span>
      <span class="unvisited" style="top:89.66%"></span>
      <span class="unvisited" style="top:90.11%"></span>
      <span class="unvisited" style="top:90.34%"></span>
      <span class="unvisited" style="top:94.38%"></span>
      <span class="unvisited" style="top:95.51%"></span>
      <span class="unvisited" style="top:95.96%"></span>
      <span class="unvisited" style="top:96.18%"></span>
      <span class="unvisited" style="top:96.40%"></span>
      <span class="unvisited" style="top:96.63%"></span>
      <span class="unvisited" style="top:97.98%"></span>
      <span class="unvisited" style="top:98.20%"></span>
      <span class="unvisited" style="top:98.43%"></span>
      <span class="unvisited" style="top:98.65%"></span>
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span > </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span > </span>
<a id="L18"></a><span > </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span > </span>
<a id="L23"></a><span > </span>
<a id="L24"></a><span > </span>
<a id="L25"></a><span > </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span > </span>
<a id="L29"></a><span > </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span > </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span > </span>
<a id="L35"></a><span > </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span > </span>
<a id="L38"></a><span class="visited"> </span>
<a id="L39"></a><span class="visited"> </span>
<a id="L40"></a><span class="visited"> </span>
<a id="L41"></a><span > </span>
<a id="L42"></a><span class="visited"> </span>
<a id="L43"></a><span > </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span > </span>
<a id="L46"></a><span > </span>
<a id="L47"></a><span class="visited"> </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span > </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span > </span>
<a id="L53"></a><span > </span>
<a id="L54"></a><span > </span>
<a id="L55"></a><span > </span>
<a id="L56"></a><span > </span>
<a id="L57"></a><span > </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span class="visited"> </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span > </span>
<a id="L63"></a><span > </span>
<a id="L64"></a><span class="visited"> </span>
<a id="L65"></a><span > </span>
<a id="L66"></a><span > </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span > </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span class="unvisited"> </span>
<a id="L73"></a><span class="unvisited"> </span>
<a id="L74"></a><span class="unvisited"> </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span class="unvisited"> </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span class="unvisited"> </span>
<a id="L80"></a><span class="unvisited"> </span>
<a id="L81"></a><span class="unvisited"> </span>
<a id="L82"></a><span class="unvisited"> </span>
<a id="L83"></a><span class="unvisited"> </span>
<a id="L84"></a><span class="unvisited"> </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span > </span>
<a id="L87"></a><span class="unvisited"> </span>
<a id="L88"></a><span class="unvisited"> </span>
<a id="L89"></a><span class="unvisited"> </span>
<a id="L90"></a><span class="unvisited"> </span>
<a id="L91"></a><span > </span>
<a id="L92"></a><span > </span>
<a id="L93"></a><span class="visited"> </span>
<a id="L94"></a><span class="visited"> </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span class="visited"> </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span > </span>
<a id="L99"></a><span > </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span class="visited"> </span>
<a id="L102"></a><span class="visited"> </span>
<a id="L103"></a><span class="visited"> </span>
<a id="L104"></a><span class="visited"> </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span > </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span class="visited"> </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span class="visited"> </span>
<a id="L111"></a><span class="visited"> </span>
<a id="L112"></a><span > </span>
<a id="L113"></a><span class="unvisited"> </span>
<a id="L114"></a><span class="unvisited"> </span>
<a id="L115"></a><span class="unvisited"> </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span > </span>
<a id="L118"></a><span > </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span > </span>
<a id="L121"></a><span > </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span > </span>
<a id="L124"></a><span > </span>
<a id="L125"></a><span > </span>
<a id="L126"></a><span > </span>
<a id="L127"></a><span > </span>
<a id="L128"></a><span > </span>
<a id="L129"></a><span > </span>
<a id="L130"></a><span > </span>
<a id="L131"></a><span > </span>
<a id="L132"></a><span > </span>
<a id="L133"></a><span > </span>
<a id="L134"></a><span > </span>
<a id="L135"></a><span > </span>
<a id="L136"></a><span > </span>
<a id="L137"></a><span > </span>
<a id="L138"></a><span > </span>
<a id="L139"></a><span > </span>
<a id="L140"></a><span > </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span > </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span > </span>
<a id="L145"></a><span > </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span class="visited"> </span>
<a id="L148"></a><span class="visited"> </span>
<a id="L149"></a><span class="visited"> </span>
<a id="L150"></a><span class="visited"> </span>
<a id="L151"></a><span class="visited"> </span>
<a id="L152"></a><span class="visited"> </span>
<a id="L153"></a><span class="visited"> </span>
<a id="L154"></a><span > </span>
<a id="L155"></a><span class="visited"> </span>
<a id="L156"></a><span class="unvisited"> </span>
<a id="L157"></a><span class="unvisited"> </span>
<a id="L158"></a><span class="unvisited"> </span>
<a id="L159"></a><span class="unvisited"> </span>
<a id="L160"></a><span class="unvisited"> </span>
<a id="L161"></a><span class="unvisited"> </span>
<a id="L162"></a><span class="unvisited"> </span>
<a id="L163"></a><span > </span>
<a id="L164"></a><span class="unvisited"> </span>
<a id="L165"></a><span > </span>
<a id="L166"></a><span > </span>
<a id="L167"></a><span > </span>
<a id="L168"></a><span > </span>
<a id="L169"></a><span > </span>
<a id="L170"></a><span > </span>
<a id="L171"></a><span > </span>
<a id="L172"></a><span > </span>
<a id="L173"></a><span > </span>
<a id="L174"></a><span > </span>
<a id="L175"></a><span > </span>
<a id="L176"></a><span > </span>
<a id="L177"></a><span > </span>
<a id="L178"></a><span > </span>
<a id="L179"></a><span > </span>
<a id="L180"></a><span class="unvisited"> </span>
<a id="L181"></a><span class="unvisited"> </span>
<a id="L182"></a><span > </span>
<a id="L183"></a><span class="unvisited"> </span>
<a id="L184"></a><span > </span>
<a id="L185"></a><span > </span>
<a id="L186"></a><span class="unvisited"> </span>
<a id="L187"></a><span > </span>
<a id="L188"></a><span class="unvisited"> </span>
<a id="L189"></a><span > </span>
<a id="L190"></a><span class="unvisited"> </span>
<a id="L191"></a><span > </span>
<a id="L192"></a><span > </span>
<a id="L193"></a><span class="unvisited"> </span>
<a id="L194"></a><span class="unvisited"> </span>
<a id="L195"></a><span > </span>
<a id="L196"></a><span > </span>
<a id="L197"></a><span class="unvisited"> </span>
<a id="L198"></a><span class="unvisited"> </span>
<a id="L199"></a><span > </span>
<a id="L200"></a><span > </span>
<a id="L201"></a><span class="unvisited"> </span>
<a id="L202"></a><span class="unvisited"> </span>
<a id="L203"></a><span > </span>
<a id="L204"></a><span > </span>
<a id="L205"></a><span class="unvisited"> </span>
<a id="L206"></a><span > </span>
<a id="L207"></a><span > </span>
<a id="L208"></a><span > </span>
<a id="L209"></a><span > </span>
<a id="L210"></a><span > </span>
<a id="L211"></a><span > </span>
<a id="L212"></a><span > </span>
<a id="L213"></a><span > </span>
<a id="L214"></a><span > </span>
<a id="L215"></a><span > </span>
<a id="L216"></a><span > </span>
<a id="L217"></a><span > </span>
<a id="L218"></a><span > </span>
<a id="L219"></a><span > </span>
<a id="L220"></a><span > </span>
<a id="L221"></a><span > </span>
<a id="L222"></a><span > </span>
<a id="L223"></a><span > </span>
<a id="L224"></a><span > </span>
<a id="L225"></a><span > </span>
<a id="L226"></a><span class="visited"> </span>
<a id="L227"></a><span > </span>
<a id="L228"></a><span > </span>
<a id="L229"></a><span > </span>
<a id="L230"></a><span class="visited"> </span>
<a id="L231"></a><span > </span>
<a id="L232"></a><span > </span>
<a id="L233"></a><span class="visited"> </span>
<a id="L234"></a><span class="visited"> </span>
<a id="L235"></a><span > </span>
<a id="L236"></a><span class="visited"> </span>
<a id="L237"></a><span > </span>
<a id="L238"></a><span > </span>
<a id="L239"></a><span > </span>
<a id="L240"></a><span > </span>
<a id="L241"></a><span class="visited"> </span>
<a id="L242"></a><span class="visited"> </span>
<a id="L243"></a><span class="visited"> </span>
<a id="L244"></a><span class="visited"> </span>
<a id="L245"></a><span > </span>
<a id="L246"></a><span > </span>
<a id="L247"></a><span > </span>
<a id="L248"></a><span class="visited"> </span>
<a id="L249"></a><span class="visited"> </span>
<a id="L250"></a><span > </span>
<a id="L251"></a><span class="visited"> </span>
<a id="L252"></a><span > </span>
<a id="L253"></a><span class="visited"> </span>
<a id="L254"></a><span > </span>
<a id="L255"></a><span > </span>
<a id="L256"></a><span > </span>
<a id="L257"></a><span class="unvisited"> </span>
<a id="L258"></a><span class="unvisited"> </span>
<a id="L259"></a><span class="unvisited"> </span>
<a id="L260"></a><span class="unvisited"> </span>
<a id="L261"></a><span > </span>
<a id="L262"></a><span > </span>
<a id="L263"></a><span > </span>
<a id="L264"></a><span class="some-visited"> </span>
<a id="L265"></a><span class="visited"> </span>
<a id="L266"></a><span class="unvisited"> </span>
<a id="L267"></a><span > </span>
<a id="L268"></a><span > </span>
<a id="L269"></a><span > </span>
<a id="L270"></a><span > </span>
<a id="L271"></a><span class="visited"> </span>
<a id="L272"></a><span > </span>
<a id="L273"></a><span > </span>
<a id="L274"></a><span class="visited"> </span>
<a id="L275"></a><span > </span>
<a id="L276"></a><span > </span>
<a id="L277"></a><span > </span>
<a id="L278"></a><span > </span>
<a id="L279"></a><span > </span>
<a id="L280"></a><span class="visited"> </span>
<a id="L281"></a><span > </span>
<a id="L282"></a><span > </span>
<a id="L283"></a><span > </span>
<a id="L284"></a><span class="visited"> </span>
<a id="L285"></a><span > </span>
<a id="L286"></a><span > </span>
<a id="L287"></a><span > </span>
<a id="L288"></a><span class="unvisited"> </span>
<a id="L289"></a><span > </span>
<a id="L290"></a><span > </span>
<a id="L291"></a><span class="some-visited"> </span>
<a id="L292"></a><span class="unvisited"> </span>
<a id="L293"></a><span > </span>
<a id="L294"></a><span class="unvisited"> </span>
<a id="L295"></a><span class="unvisited"> </span>
<a id="L296"></a><span class="unvisited"> </span>
<a id="L297"></a><span > </span>
<a id="L298"></a><span class="unvisited"> </span>
<a id="L299"></a><span class="unvisited"> </span>
<a id="L300"></a><span class="visited"> </span>
<a id="L301"></a><span class="visited"> </span>
<a id="L302"></a><span class="visited"> </span>
<a id="L303"></a><span class="visited"> </span>
<a id="L304"></a><span > </span>
<a id="L305"></a><span > </span>
<a id="L306"></a><span > </span>
<a id="L307"></a><span class="visited"> </span>
<a id="L308"></a><span class="visited"> </span>
<a id="L309"></a><span > </span>
<a id="L310"></a><span class="visited"> </span>
<a id="L311"></a><span class="visited"> </span>
<a id="L312"></a><span class="visited"> </span>
<a id="L313"></a><span class="visited"> </span>
<a id="L314"></a><span > </span>
<a id="L315"></a><span class="visited"> </span>
<a id="L316"></a><span class="visited"> </span>
<a id="L317"></a><span class="visited"> </span>
<a id="L318"></a><span > </span>
<a id="L319"></a><span > </span>
<a id="L320"></a><span class="visited"> </span>
<a id="L321"></a><span class="visited"> </span>
<a id="L322"></a><span > </span>
<a id="L323"></a><span class="visited"> </span>
<a id="L324"></a><span class="visited"> </span>
<a id="L325"></a><span class="visited"> </span>
<a id="L326"></a><span class="visited"> </span>
<a id="L327"></a><span > </span>
<a id="L328"></a><span class="visited"> </span>
<a id="L329"></a><span class="visited"> </span>
<a id="L330"></a><span class="visited"> </span>
<a id="L331"></a><span > </span>
<a id="L332"></a><span > </span>
<a id="L333"></a><span > </span>
<a id="L334"></a><span > </span>
<a id="L335"></a><span > </span>
<a id="L336"></a><span > </span>
<a id="L337"></a><span > </span>
<a id="L338"></a><span > </span>
<a id="L339"></a><span > </span>
<a id="L340"></a><span > </span>
<a id="L341"></a><span class="visited"> </span>
<a id="L342"></a><span class="visited"> </span>
<a id="L343"></a><span > </span>
<a id="L344"></a><span class="visited"> </span>
<a id="L345"></a><span class="visited"> </span>
<a id="L346"></a><span > </span>
<a id="L347"></a><span class="visited"> </span>
<a id="L348"></a><span > </span>
<a id="L349"></a><span class="visited"> </span>
<a id="L350"></a><span class="visited"> </span>
<a id="L351"></a><span > </span>
<a id="L352"></a><span > </span>
<a id="L353"></a><span class="visited"> </span>
<a id="L354"></a><span > </span>
<a id="L355"></a><span class="unvisited"> </span>
<a id="L356"></a><span > </span>
<a id="L357"></a><span > </span>
<a id="L358"></a><span > </span>
<a id="L359"></a><span > </span>
<a id="L360"></a><span > </span>
<a id="L361"></a><span > </span>
<a id="L362"></a><span class="visited"> </span>
<a id="L363"></a><span > </span>
<a id="L364"></a><span class="visited"> </span>
<a id="L365"></a><span class="visited"> </span>
<a id="L366"></a><span > </span>
<a id="L367"></a><span > </span>
<a id="L368"></a><span > </span>
<a id="L369"></a><span > </span>
<a id="L370"></a><span > </span>
<a id="L371"></a><span > </span>
<a id="L372"></a><span > </span>
<a id="L373"></a><span > </span>
<a id="L374"></a><span > </span>
<a id="L375"></a><span > </span>
<a id="L376"></a><span class="unvisited"> </span>
<a id="L377"></a><span class="unvisited"> </span>
<a id="L378"></a><span > </span>
<a id="L379"></a><span class="unvisited"> </span>
<a id="L380"></a><span class="unvisited"> </span>
<a id="L381"></a><span class="unvisited"> </span>
<a id="L382"></a><span > </span>
<a id="L383"></a><span class="unvisited"> </span>
<a id="L384"></a><span > </span>
<a id="L385"></a><span class="unvisited"> </span>
<a id="L386"></a><span class="unvisited"> </span>
<a id="L387"></a><span > </span>
<a id="L388"></a><span > </span>
<a id="L389"></a><span class="unvisited"> </span>
<a id="L390"></a><span > </span>
<a id="L391"></a><span class="unvisited"> </span>
<a id="L392"></a><span > </span>
<a id="L393"></a><span > </span>
<a id="L394"></a><span class="unvisited"> </span>
<a id="L395"></a><span > </span>
<a id="L396"></a><span > </span>
<a id="L397"></a><span class="unvisited"> </span>
<a id="L398"></a><span > </span>
<a id="L399"></a><span class="unvisited"> </span>
<a id="L400"></a><span > </span>
<a id="L401"></a><span class="unvisited"> </span>
<a id="L402"></a><span class="unvisited"> </span>
<a id="L403"></a><span > </span>
<a id="L404"></a><span > </span>
<a id="L405"></a><span > </span>
<a id="L406"></a><span > </span>
<a id="L407"></a><span > </span>
<a id="L408"></a><span > </span>
<a id="L409"></a><span > </span>
<a id="L410"></a><span class="visited"> </span>
<a id="L411"></a><span class="visited"> </span>
<a id="L412"></a><span > </span>
<a id="L413"></a><span > </span>
<a id="L414"></a><span > </span>
<a id="L415"></a><span > </span>
<a id="L416"></a><span > </span>
<a id="L417"></a><span > </span>
<a id="L418"></a><span > </span>
<a id="L419"></a><span class="visited"> </span>
<a id="L420"></a><span class="unvisited"> </span>
<a id="L421"></a><span > </span>
<a id="L422"></a><span class="visited"> </span>
<a id="L423"></a><span > </span>
<a id="L424"></a><span > </span>
<a id="L425"></a><span class="unvisited"> </span>
<a id="L426"></a><span > </span>
<a id="L427"></a><span class="unvisited"> </span>
<a id="L428"></a><span class="unvisited"> </span>
<a id="L429"></a><span class="unvisited"> </span>
<a id="L430"></a><span class="unvisited"> </span>
<a id="L431"></a><span > </span>
<a id="L432"></a><span class="visited"> </span>
<a id="L433"></a><span class="visited"> </span>
<a id="L434"></a><span class="visited"> </span>
<a id="L435"></a><span class="visited"> </span>
<a id="L436"></a><span class="unvisited"> </span>
<a id="L437"></a><span class="unvisited"> </span>
<a id="L438"></a><span class="unvisited"> </span>
<a id="L439"></a><span class="unvisited"> </span>
<a id="L440"></a><span > </span>
<a id="L441"></a><span > </span>
<a id="L442"></a><span > </span>
<a id="L443"></a><span > </span>
<a id="L444"></a><span > </span>
<a id="L445"></a><span > </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
<a href="#L235">235</a>
<a href="#L236">236</a>
<a href="#L237">237</a>
<a href="#L238">238</a>
<a href="#L239">239</a>
<a href="#L240">240</a>
<a href="#L241">241</a>
<a href="#L242">242</a>
<a href="#L243">243</a>
<a href="#L244">244</a>
<a href="#L245">245</a>
<a href="#L246">246</a>
<a href="#L247">247</a>
<a href="#L248">248</a>
<a href="#L249">249</a>
<a href="#L250">250</a>
<a href="#L251">251</a>
<a href="#L252">252</a>
<a href="#L253">253</a>
<a href="#L254">254</a>
<a href="#L255">255</a>
<a href="#L256">256</a>
<a href="#L257">257</a>
<a href="#L258">258</a>
<a href="#L259">259</a>
<a href="#L260">260</a>
<a href="#L261">261</a>
<a href="#L262">262</a>
<a href="#L263">263</a>
<a href="#L264">264</a>
<a href="#L265">265</a>
<a href="#L266">266</a>
<a href="#L267">267</a>
<a href="#L268">268</a>
<a href="#L269">269</a>
<a href="#L270">270</a>
<a href="#L271">271</a>
<a href="#L272">272</a>
<a href="#L273">273</a>
<a href="#L274">274</a>
<a href="#L275">275</a>
<a href="#L276">276</a>
<a href="#L277">277</a>
<a href="#L278">278</a>
<a href="#L279">279</a>
<a href="#L280">280</a>
<a href="#L281">281</a>
<a href="#L282">282</a>
<a href="#L283">283</a>
<a href="#L284">284</a>
<a href="#L285">285</a>
<a href="#L286">286</a>
<a href="#L287">287</a>
<a href="#L288">288</a>
<a href="#L289">289</a>
<a href="#L290">290</a>
<a href="#L291">291</a>
<a href="#L292">292</a>
<a href="#L293">293</a>
<a href="#L294">294</a>
<a href="#L295">295</a>
<a href="#L296">296</a>
<a href="#L297">297</a>
<a href="#L298">298</a>
<a href="#L299">299</a>
<a href="#L300">300</a>
<a href="#L301">301</a>
<a href="#L302">302</a>
<a href="#L303">303</a>
<a href="#L304">304</a>
<a href="#L305">305</a>
<a href="#L306">306</a>
<a href="#L307">307</a>
<a href="#L308">308</a>
<a href="#L309">309</a>
<a href="#L310">310</a>
<a href="#L311">311</a>
<a href="#L312">312</a>
<a href="#L313">313</a>
<a href="#L314">314</a>
<a href="#L315">315</a>
<a href="#L316">316</a>
<a href="#L317">317</a>
<a href="#L318">318</a>
<a href="#L319">319</a>
<a href="#L320">320</a>
<a href="#L321">321</a>
<a href="#L322">322</a>
<a href="#L323">323</a>
<a href="#L324">324</a>
<a href="#L325">325</a>
<a href="#L326">326</a>
<a href="#L327">327</a>
<a href="#L328">328</a>
<a href="#L329">329</a>
<a href="#L330">330</a>
<a href="#L331">331</a>
<a href="#L332">332</a>
<a href="#L333">333</a>
<a href="#L334">334</a>
<a href="#L335">335</a>
<a href="#L336">336</a>
<a href="#L337">337</a>
<a href="#L338">338</a>
<a href="#L339">339</a>
<a href="#L340">340</a>
<a href="#L341">341</a>
<a href="#L342">342</a>
<a href="#L343">343</a>
<a href="#L344">344</a>
<a href="#L345">345</a>
<a href="#L346">346</a>
<a href="#L347">347</a>
<a href="#L348">348</a>
<a href="#L349">349</a>
<a href="#L350">350</a>
<a href="#L351">351</a>
<a href="#L352">352</a>
<a href="#L353">353</a>
<a href="#L354">354</a>
<a href="#L355">355</a>
<a href="#L356">356</a>
<a href="#L357">357</a>
<a href="#L358">358</a>
<a href="#L359">359</a>
<a href="#L360">360</a>
<a href="#L361">361</a>
<a href="#L362">362</a>
<a href="#L363">363</a>
<a href="#L364">364</a>
<a href="#L365">365</a>
<a href="#L366">366</a>
<a href="#L367">367</a>
<a href="#L368">368</a>
<a href="#L369">369</a>
<a href="#L370">370</a>
<a href="#L371">371</a>
<a href="#L372">372</a>
<a href="#L373">373</a>
<a href="#L374">374</a>
<a href="#L375">375</a>
<a href="#L376">376</a>
<a href="#L377">377</a>
<a href="#L378">378</a>
<a href="#L379">379</a>
<a href="#L380">380</a>
<a href="#L381">381</a>
<a href="#L382">382</a>
<a href="#L383">383</a>
<a href="#L384">384</a>
<a href="#L385">385</a>
<a href="#L386">386</a>
<a href="#L387">387</a>
<a href="#L388">388</a>
<a href="#L389">389</a>
<a href="#L390">390</a>
<a href="#L391">391</a>
<a href="#L392">392</a>
<a href="#L393">393</a>
<a href="#L394">394</a>
<a href="#L395">395</a>
<a href="#L396">396</a>
<a href="#L397">397</a>
<a href="#L398">398</a>
<a href="#L399">399</a>
<a href="#L400">400</a>
<a href="#L401">401</a>
<a href="#L402">402</a>
<a href="#L403">403</a>
<a href="#L404">404</a>
<a href="#L405">405</a>
<a href="#L406">406</a>
<a href="#L407">407</a>
<a href="#L408">408</a>
<a href="#L409">409</a>
<a href="#L410">410</a>
<a href="#L411">411</a>
<a href="#L412">412</a>
<a href="#L413">413</a>
<a href="#L414">414</a>
<a href="#L415">415</a>
<a href="#L416">416</a>
<a href="#L417">417</a>
<a href="#L418">418</a>
<a href="#L419">419</a>
<a href="#L420">420</a>
<a href="#L421">421</a>
<a href="#L422">422</a>
<a href="#L423">423</a>
<a href="#L424">424</a>
<a href="#L425">425</a>
<a href="#L426">426</a>
<a href="#L427">427</a>
<a href="#L428">428</a>
<a href="#L429">429</a>
<a href="#L430">430</a>
<a href="#L431">431</a>
<a href="#L432">432</a>
<a href="#L433">433</a>
<a href="#L434">434</a>
<a href="#L435">435</a>
<a href="#L436">436</a>
<a href="#L437">437</a>
<a href="#L438">438</a>
<a href="#L439">439</a>
<a href="#L440">440</a>
<a href="#L441">441</a>
<a href="#L442">442</a>
<a href="#L443">443</a>
<a href="#L444">444</a>
<a href="#L445">445</a>
</pre>
        <pre id="code">
(* OCaml promise library
 * http://www.ocsigen.org/lwt
 * Copyright (C) 2011 Jérémie Dimino
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation, with linking exceptions;
 * either version 2.1 of the License, or (at your option) any later
 * version. See COPYING file for details.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 * 02111-1307, USA.
 *)

(* +-----------------------------------------------------------------+
   | Events                                                          |
   +-----------------------------------------------------------------+ *)

type _event = {
  stop : unit Lazy.t;
  (* The stop method of the event. *)
  node : Obj.t Lwt_sequence.node;
  (* The node in the sequence of registered events. *)
}

type event = _event ref

external cast_node : 'a Lwt_sequence.node -&gt; Obj.t Lwt_sequence.node = "%identity"

let stop_event ev =
  <span data-count="29">l</span>et ev = <span data-count="29">!</span>ev in
  <span data-count="29">L</span>wt_sequence.remove ev.node;
  <span data-count="29">L</span>azy.force ev.stop

let _fake_event = <span data-count="5">{</span>
  stop = lazy ();
  node = Lwt_sequence.add_l (Obj.repr ()) (Lwt_sequence.create ());
}

let fake_event = <span data-count="5">r</span>ef _fake_event

(* +-----------------------------------------------------------------+
   | Engines                                                         |
   +-----------------------------------------------------------------+ *)

class virtual abstract = object(self)
  method virtual iter : bool -&gt; unit
  method virtual private cleanup : unit
  method virtual private register_readable : Unix.file_descr -&gt; (unit -&gt; unit) -&gt; unit Lazy.t
  method virtual private register_writable : Unix.file_descr -&gt; (unit -&gt; unit) -&gt; unit Lazy.t
  method virtual private register_timer : float -&gt; bool -&gt; (unit -&gt; unit) -&gt; unit Lazy.t

  val readables = <span data-count="5">L</span>wt_sequence.create ()
    (* Sequence of callbacks waiting for a file descriptor to become
       readable. *)

  val writables = <span data-count="5">L</span>wt_sequence.create ()
    (* Sequence of callbacks waiting for a file descriptor to become
       writable. *)

  val timers = <span data-count="5">L</span>wt_sequence.create ()
    (* Sequence of timers. *)

  method destroy =
    <span data-count="0">L</span>wt_sequence.iter_l (fun (_fd, _f, _g, ev) -&gt; <span data-count="0">s</span>top_event ev) readables;
    <span data-count="0">L</span>wt_sequence.iter_l (fun (_fd, _f, _g, ev) -&gt; <span data-count="0">s</span>top_event ev) writables;
    <span data-count="0">L</span>wt_sequence.iter_l (fun (_delay, _repeat, _f, _g, ev) -&gt; <span data-count="0">s</span>top_event ev)
      timers;
    <span data-count="0">s</span>elf#cleanup

  method transfer (engine : abstract) =
    <span data-count="0">L</span>wt_sequence.iter_l (fun (fd, f, _g, ev) -&gt;
      <span data-count="0">s</span>top_event ev; <span data-count="0">e</span>v := !(engine#on_readable fd f)) readables;
    <span data-count="0">L</span>wt_sequence.iter_l (fun (fd, f, _g, ev) -&gt;
      <span data-count="0">s</span>top_event ev; <span data-count="0">e</span>v := !(engine#on_writable fd f)) writables;
    <span data-count="0">L</span>wt_sequence.iter_l (fun (delay, repeat, f, _g, ev) -&gt;
      <span data-count="0">s</span>top_event ev; <span data-count="0">e</span>v := !(engine#on_timer delay repeat f)) timers

  method fake_io fd =
    <span data-count="0">L</span>wt_sequence.iter_l (fun (fd', _f, g, _stop) -&gt;
      <span data-count="0">i</span>f fd = fd' then <span data-count="0">g</span> ()) readables;
    <span data-count="0">L</span>wt_sequence.iter_l (fun (fd', _f, g, _stop) -&gt;
      <span data-count="0">i</span>f fd = fd' then <span data-count="0">g</span> ()) writables

  method on_readable fd f =
    <span data-count="16">l</span>et ev = <span data-count="16">r</span>ef _fake_event in
    <span data-count="16">l</span>et g () = <span data-count="40011">f</span> ev in
    <span data-count="16">l</span>et stop = <span data-count="16">s</span>elf#register_readable fd g in
    <span data-count="16">e</span>v := { stop = stop; node = cast_node (Lwt_sequence.add_r (fd, f, g, ev) readables) };
    <span data-count="16">e</span>v

  method on_writable fd f =
    <span data-count="6">l</span>et ev = <span data-count="6">r</span>ef _fake_event in
    <span data-count="6">l</span>et g () = <span data-count="6">f</span> ev in
    <span data-count="6">l</span>et stop = <span data-count="6">s</span>elf#register_writable fd g in
    <span data-count="6">e</span>v := { stop = stop; node = cast_node (Lwt_sequence.add_r (fd, f, g, ev) writables) } ;
    <span data-count="6">e</span>v

  method on_timer delay repeat f =
    <span data-count="12">l</span>et ev = <span data-count="12">r</span>ef _fake_event in
    <span data-count="12">l</span>et g () = <span data-count="11">f</span> ev in
    <span data-count="12">l</span>et stop = <span data-count="12">s</span>elf#register_timer delay repeat g in
    <span data-count="12">e</span>v := { stop = stop; node = cast_node (Lwt_sequence.add_r (delay, repeat, f, g, ev) timers) };
    <span data-count="12">e</span>v

  method readable_count = <span data-count="0">L</span>wt_sequence.length readables
  method writable_count = <span data-count="0">L</span>wt_sequence.length writables
  method timer_count = <span data-count="0">L</span>wt_sequence.length timers
end

class type t = object
  inherit abstract

  method iter : bool -&gt; unit
  method private cleanup : unit
  method private register_readable : Unix.file_descr -&gt; (unit -&gt; unit) -&gt; unit Lazy.t
  method private register_writable : Unix.file_descr -&gt; (unit -&gt; unit) -&gt; unit Lazy.t
  method private register_timer : float -&gt; bool -&gt; (unit -&gt; unit) -&gt; unit Lazy.t
end

(* +-----------------------------------------------------------------+
   | The libev engine                                                |
   +-----------------------------------------------------------------+ *)

type ev_loop
type ev_io
type ev_timer

module Ev_backend =
struct
  type t =
    | EV_DEFAULT
    | EV_SELECT
    | EV_POLL
    | EV_EPOLL
    | EV_KQUEUE
    | EV_DEVPOLL
    | EV_PORT

  let default = <span data-count="5">E</span>V_DEFAULT
  let select = <span data-count="5">E</span>V_SELECT
  let poll = <span data-count="5">E</span>V_POLL
  let epoll = <span data-count="5">E</span>V_EPOLL
  let kqueue = <span data-count="5">E</span>V_KQUEUE
  let devpoll = <span data-count="5">E</span>V_DEVPOLL
  let port = <span data-count="5">E</span>V_PORT

  let name = <span data-count="5">f</span>unction
    | <span data-count="0">E</span>V_DEFAULT -&gt; "EV_DEFAULT"
    | <span data-count="0">E</span>V_SELECT -&gt; "EV_SELECT"
    | <span data-count="0">E</span>V_POLL -&gt; "EV_POLL"
    | <span data-count="0">E</span>V_EPOLL -&gt; "EV_EPOLL"
    | <span data-count="0">E</span>V_KQUEUE -&gt; "EV_KQUEUE"
    | <span data-count="0">E</span>V_DEVPOLL -&gt; "EV_DEVPOLL"
    | <span data-count="0">E</span>V_PORT -&gt; "EV_PORT"

  let pp fmt t = <span data-count="0">F</span>ormat.pp_print_string fmt (name t)
end

external ev_init : Ev_backend.t -&gt; ev_loop = "lwt_libev_init"
external ev_stop : ev_loop -&gt; unit = "lwt_libev_stop"
external ev_loop : ev_loop -&gt; bool -&gt; unit = "lwt_libev_loop"
external ev_unloop : ev_loop -&gt; unit = "lwt_libev_unloop"
external ev_readable_init : ev_loop -&gt; Unix.file_descr -&gt; (unit -&gt; unit) -&gt; ev_io = "lwt_libev_readable_init"
external ev_writable_init : ev_loop -&gt; Unix.file_descr -&gt; (unit -&gt; unit) -&gt; ev_io = "lwt_libev_writable_init"
external ev_io_stop : ev_loop -&gt; ev_io -&gt; unit = "lwt_libev_io_stop"
external ev_timer_init : ev_loop -&gt; float -&gt; bool -&gt; (unit -&gt; unit) -&gt; ev_timer = "lwt_libev_timer_init"
external ev_timer_stop : ev_loop -&gt; ev_timer -&gt; unit  = "lwt_libev_timer_stop"

class libev ?(backend=Ev_backend.default) () = object
  inherit abstract

  val loop = <span data-count="0">e</span>v_init backend
  method loop = <span data-count="0">l</span>oop

  method private cleanup = <span data-count="0">e</span>v_stop loop

  method iter block =
    <span data-count="0">t</span>ry
      ev_loop loop block
    with <span data-count="0">e</span>xn -&gt;
      ev_unloop loop;
      <span data-count="0">r</span>aise exn

  method private register_readable fd f =
    <span data-count="0">l</span>et ev = <span data-count="0">e</span>v_readable_init loop fd f in
    <span data-count="0">l</span>azy(ev_io_stop loop ev)

  method private register_writable fd f =
    <span data-count="0">l</span>et ev = <span data-count="0">e</span>v_writable_init loop fd f in
    <span data-count="0">l</span>azy(ev_io_stop loop ev)

  method private register_timer delay repeat f =
    <span data-count="0">l</span>et ev = <span data-count="0">e</span>v_timer_init loop delay repeat f in
    <span data-count="0">l</span>azy(ev_timer_stop loop ev)
end

class libev_deprecated = libev <span data-count="0">(</span>)

(* +-----------------------------------------------------------------+
   | Select/poll based engines                                       |
   +-----------------------------------------------------------------+ *)

(* Type of a sleeper for the select engine. *)
type sleeper = {
  mutable time : float;
  (* The time at which the sleeper should be wakeup. *)

  mutable stopped : bool;
  (* [true] iff the event has been stopped. *)

  action : unit -&gt; unit;
  (* The action for the sleeper. *)
}

module Sleep_queue =
  Lwt_pqueue.Make(struct
                    type t = sleeper
                    let compare {time = t1; _} {time = t2; _} = <span data-count="2">c</span>ompare t1 t2
                  end)
  [@@ocaml.warning "-3"]

module Fd_map = Map.Make(struct type t = Unix.file_descr let compare = <span data-count="5">c</span>ompare end)

let rec restart_actions sleep_queue now =
  <span data-count="40046">m</span>atch Sleep_queue.lookup_min sleep_queue with
    | <span data-count="1">S</span>ome{ stopped = true; _ } -&gt;
        restart_actions (Sleep_queue.remove_min sleep_queue) now
    | <span data-count="11">S</span>ome{ time = time; action = action; _ } when <span data-count="13">t</span>ime &lt;= now -&gt;
        (* We have to remove the sleeper to the queue before performing
           the action. The action can change the sleeper's time, and this
           might break the priority queue invariant if the sleeper is
           still in the queue. *)
        let q = <span data-count="11">S</span>leep_queue.remove_min sleep_queue in
        <span data-count="11">a</span>ction ();
        <span data-count="11">r</span>estart_actions q now
    | <span data-count="40034">_</span> -&gt;
        sleep_queue

let rec get_next_timeout sleep_queue =
  <span data-count="40027">m</span>atch Sleep_queue.lookup_min sleep_queue with
    | <span data-count="1">S</span>ome{ stopped = true; _ } -&gt;
        get_next_timeout (Sleep_queue.remove_min sleep_queue)
    | <span data-count="11">S</span>ome{ time = time; _ } -&gt;
        max 0. (time -. Unix.gettimeofday ())
    | <span data-count="40015">N</span>one -&gt;
        -1.

let bad_fd fd =
  <span data-count="0">t</span>ry
    let _ = <span data-count="0">U</span>nix.fstat fd in
    <span data-count="0">f</span>alse
  with <span data-count="0">U</span>nix.Unix_error (_, _, _) -&gt;
    true

let invoke_actions fd map =
  <span data-count="40017">m</span>atch try Some(Fd_map.find fd map) with <span data-count="0">N</span>ot_found -&gt; None with
    | <span data-count="40017">S</span>ome actions -&gt; Lwt_sequence.iter_l (fun f -&gt; <span data-count="40017">f</span> ()) actions
    | <span data-count="0">N</span>one -&gt; ()

class virtual select_or_poll_based = object
  inherit abstract

  val mutable sleep_queue = <span data-count="5">S</span>leep_queue.empty
    (* Threads waiting for a timeout to expire. *)

  val mutable new_sleeps = <span data-count="5">[</span>]
    (* Sleepers added since the last iteration of the main loop:

       They are not added immediately to the main sleep queue in order
       to prevent them from being wakeup immediately.  *)

  val mutable wait_readable = <span data-count="5">F</span>d_map.empty
    (* Sequences of actions waiting for file descriptors to become
       readable. *)

  val mutable wait_writable = <span data-count="5">F</span>d_map.empty
    (* Sequences of actions waiting for file descriptors to become
       writable. *)

  method private cleanup = <span data-count="0">(</span>)

  method private register_timer delay repeat f =
    <span data-count="12">i</span>f repeat then <span data-count="0">b</span>egin
      let rec sleeper = <span data-count="0">{</span> time = Unix.gettimeofday () +. delay; stopped = false; action = g }
      and g () =
        <span data-count="0">s</span>leeper.time &lt;- Unix.gettimeofday () +. delay;
        <span data-count="0">n</span>ew_sleeps &lt;- sleeper :: new_sleeps;
        <span data-count="0">f</span> ()
      in
      <span data-count="0">n</span>ew_sleeps &lt;- sleeper :: new_sleeps;
      <span data-count="0">l</span>azy(sleeper.stopped &lt;- true)
    end else <span data-count="12">b</span>egin
      let sleeper = <span data-count="12">{</span> time = Unix.gettimeofday () +. delay; stopped = false; action = f } in
      <span data-count="12">n</span>ew_sleeps &lt;- sleeper :: new_sleeps;
      <span data-count="12">l</span>azy(sleeper.stopped &lt;- true)
    end

  method private register_readable fd f =
    <span data-count="16">l</span>et actions =
      <span data-count="16">t</span>ry
        Fd_map.find fd wait_readable
      with <span data-count="16">N</span>ot_found -&gt;
        let actions = <span data-count="16">L</span>wt_sequence.create () in
        <span data-count="16">w</span>ait_readable &lt;- Fd_map.add fd actions wait_readable;
        <span data-count="16">a</span>ctions
    in
    <span data-count="16">l</span>et node = <span data-count="16">L</span>wt_sequence.add_l f actions in
    <span data-count="16">l</span>azy(Lwt_sequence.remove node;
         <span data-count="11">i</span>f Lwt_sequence.is_empty actions then <span data-count="11">w</span>ait_readable &lt;- Fd_map.remove fd wait_readable)

  method private register_writable fd f =
    <span data-count="6">l</span>et actions =
      <span data-count="6">t</span>ry
        Fd_map.find fd wait_writable
      with <span data-count="6">N</span>ot_found -&gt;
        let actions = <span data-count="6">L</span>wt_sequence.create () in
        <span data-count="6">w</span>ait_writable &lt;- Fd_map.add fd actions wait_writable;
        <span data-count="6">a</span>ctions
    in
    <span data-count="6">l</span>et node = <span data-count="6">L</span>wt_sequence.add_l f actions in
    <span data-count="6">l</span>azy(Lwt_sequence.remove node;
         <span data-count="6">i</span>f Lwt_sequence.is_empty actions then <span data-count="6">w</span>ait_writable &lt;- Fd_map.remove fd wait_writable)
end

class virtual select_based = object(self)
  inherit select_or_poll_based

  method private virtual select : Unix.file_descr list -&gt; Unix.file_descr list -&gt; float -&gt; Unix.file_descr list * Unix.file_descr list

  method iter block =
    (* Transfer all sleepers added since the last iteration to the
       main sleep queue: *)
    <span data-count="40034">s</span>leep_queue &lt;- List.fold_left (fun q e -&gt; <span data-count="12">S</span>leep_queue.add e q) sleep_queue new_sleeps;
    <span data-count="40034">n</span>ew_sleeps &lt;- [];
    (* Collect file descriptors. *)
    <span data-count="40034">l</span>et fds_r = <span data-count="40034">F</span>d_map.fold (fun fd _ l -&gt; <span data-count="40055">f</span>d :: l) wait_readable [] in
    <span data-count="40034">l</span>et fds_w = <span data-count="40034">F</span>d_map.fold (fun fd _ l -&gt; <span data-count="6">f</span>d :: l) wait_writable [] in
    (* Compute the timeout. *)
    <span data-count="40034">l</span>et timeout = <span data-count="40034">i</span>f block then <span data-count="40026">g</span>et_next_timeout sleep_queue else <span data-count="8">0</span>. in
    (* Do the blocking call *)
    <span data-count="40034">l</span>et fds_r, fds_w =
      <span data-count="40034">t</span>ry
        self#select fds_r fds_w timeout
      with
        | <span data-count="3">U</span>nix.Unix_error (Unix.EINTR, _, _) -&gt;
            ([], [])
        | <span data-count="0">U</span>nix.Unix_error (Unix.EBADF, _, _) -&gt;
            (* Keeps only bad file descriptors. Actions registered on
               them have to handle the error: *)
            (List.filter bad_fd fds_r,
             List.filter bad_fd fds_w)
    in
    (* Restart threads waiting for a timeout: *)
    <span data-count="40034">s</span>leep_queue &lt;- restart_actions sleep_queue (Unix.gettimeofday ());
    (* Restart threads waiting on a file descriptors: *)
    <span data-count="40034">L</span>ist.iter (fun fd -&gt; <span data-count="40011">i</span>nvoke_actions fd wait_readable) fds_r;
    <span data-count="40034">L</span>ist.iter (fun fd -&gt; <span data-count="6">i</span>nvoke_actions fd wait_writable) fds_w
end

class virtual poll_based = object(self)
  inherit select_or_poll_based

  method private virtual poll : (Unix.file_descr * bool * bool) list -&gt; float -&gt; (Unix.file_descr * bool * bool) list

  method iter block =
    (* Transfer all sleepers added since the last iteration to the
       main sleep queue: *)
    <span data-count="0">s</span>leep_queue &lt;- List.fold_left (fun q e -&gt; <span data-count="0">S</span>leep_queue.add e q) sleep_queue new_sleeps;
    <span data-count="0">n</span>ew_sleeps &lt;- [];
    (* Collect file descriptors. *)
    <span data-count="0">l</span>et fds = <span data-count="0">[</span>] in
    <span data-count="0">l</span>et fds = <span data-count="0">F</span>d_map.fold (fun fd _ l -&gt; <span data-count="0">(</span>fd, true, false) :: l) wait_readable fds in
    <span data-count="0">l</span>et fds = <span data-count="0">F</span>d_map.fold (fun fd _ l -&gt; <span data-count="0">(</span>fd, false, true) :: l) wait_writable fds in
    (* Compute the timeout. *)
    <span data-count="0">l</span>et timeout = <span data-count="0">i</span>f block then <span data-count="0">g</span>et_next_timeout sleep_queue else <span data-count="0">0</span>. in
    (* Do the blocking call *)
    <span data-count="0">l</span>et fds =
      <span data-count="0">t</span>ry
        self#poll fds timeout
      with
        | <span data-count="0">U</span>nix.Unix_error (Unix.EINTR, _, _) -&gt;
            []
        | <span data-count="0">U</span>nix.Unix_error (Unix.EBADF, _, _) -&gt;
            (* Keeps only bad file descriptors. Actions registered on
               them have to handle the error: *)
            List.filter (fun (fd, _, _) -&gt; <span data-count="0">b</span>ad_fd fd) fds
    in
    (* Restart threads waiting for a timeout: *)
    <span data-count="0">s</span>leep_queue &lt;- restart_actions sleep_queue (Unix.gettimeofday ());
    (* Restart threads waiting on a file descriptors: *)
    <span data-count="0">L</span>ist.iter
      (fun (fd, readable, writable) -&gt;
         <span data-count="0">i</span>f readable then <span data-count="0">i</span>nvoke_actions fd wait_readable;
         <span data-count="0">i</span>f writable then <span data-count="0">i</span>nvoke_actions fd wait_writable)
      fds
end

class select = object
  inherit select_based

  method private select fds_r fds_w timeout =
    <span data-count="40034">l</span>et fds_r, fds_w, _ = <span data-count="40034">U</span>nix.select fds_r fds_w [] timeout in
    <span data-count="40031">(</span>fds_r, fds_w)
end

(* +-----------------------------------------------------------------+
   | The current engine                                              |
   +-----------------------------------------------------------------+ *)

let current =
  <span data-count="5">i</span>f <span data-count="5">L</span>wt_config._HAVE_LIBEV &amp;&amp; <span data-count="5">L</span>wt_config.libev_default then
    <span data-count="0">r</span>ef (new libev () :&gt; t)
  else
    <span data-count="5">r</span>ef (new select :&gt; t)

let get () =
  <span data-count="0">!</span>current

let set ?(transfer=<span data-count="0">t</span>rue) ?(destroy=<span data-count="0">t</span>rue) engine =
  <span data-count="0">i</span>f transfer then <span data-count="0">!</span>current#transfer (engine : #t :&gt; abstract);
  <span data-count="0">i</span>f destroy then <span data-count="0">!</span>current#destroy;
  <span data-count="0">c</span>urrent := (engine : #t :&gt; t)

let iter block = <span data-count="40034">!</span>current#iter block
let on_readable fd f = <span data-count="16">!</span>current#on_readable fd f
let on_writable fd f = <span data-count="6">!</span>current#on_writable fd f
let on_timer delay repeat f = <span data-count="12">!</span>current#on_timer delay repeat f
let fake_io fd = <span data-count="0">!</span>current#fake_io fd
let readable_count () = <span data-count="0">!</span>current#readable_count
let writable_count () = <span data-count="0">!</span>current#writable_count
let timer_count () = <span data-count="0">!</span>current#timer_count

module Versioned =
struct
  class libev_1 = libev_deprecated
  class libev_2 = libev
end
</pre>
      </div>
    </div>
    <div id="footer">Generated on 2017-05-31 10:06:51 by <a href="https://github.com/aantron/bisect_ppx">Bisect_ppx</a> 1.2.0</div>
    <script src="coverage.js"></script>
  </body>
</html>
